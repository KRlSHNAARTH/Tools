<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnKP - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; }
        .glass-card { background: #0f0f0f; border: 1px solid #222; border-radius: 24px; }
        .btn-premium { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border-radius: 14px; font-weight: 700; transition: 0.2s; }
        input { background: #111 !important; border: 1px solid #333 !important; color: #fff !important; border-radius: 14px !important; padding: 14px !important; width: 100%; margin-bottom: 12px; outline: none; }
        .hidden { display: none; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <!-- LOGIN FORM -->
    <div id="auth-login" class="w-full max-w-sm glass-card p-8">
        <h1 class="text-3xl font-black text-green-500 text-center mb-8">EARNKP</h1>
        <input type="text" id="login-uid" placeholder="User ID (KP00001)">
        <input type="password" id="login-pass" placeholder="Password">
        <button onclick="login()" class="btn-premium w-full py-4 mt-4">LOG IN</button>
        <p class="text-center mt-6 text-zinc-500 text-sm">New? <button onclick="toggleAuth()" class="text-green-500 font-bold">Register</button></p>
    </div>

    <!-- REGISTER FORM -->
    <div id="auth-register" class="w-full max-w-sm glass-card p-8 hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
        <input type="text" id="reg-name" placeholder="Full Name">
        <input type="email" id="reg-email" placeholder="Email">
        <input type="tel" id="reg-phone" placeholder="Phone Number">
        <input type="password" id="reg-pass" placeholder="Password">
        <input type="text" id="reg-ref" placeholder="Referral ID (Optional)">
        <button onclick="register()" class="btn-premium w-full py-4 mt-4">REGISTER</button>
        <button onclick="toggleAuth()" class="w-full mt-4 text-zinc-500 text-sm">Back to Login</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBM2yLCY-Rz10hPjYLZ-UDw9RGTiveLWEE",
            authDomain: "earnkp-ffebc.firebaseapp.com",
            projectId: "earnkp-ffebc",
            storageBucket: "earnkp-ffebc.firebasestorage.app",
            messagingSenderId: "724007533070",
            appId: "1:724007533070:web:12e98f84828a8624429a5f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if already logged in
        onAuthStateChanged(auth, (user) => {
            if (user) window.location.href = 'dashboard.html';
        });

        window.toggleAuth = () => {
            document.getElementById('auth-login').classList.toggle('hidden');
            document.getElementById('auth-register').classList.toggle('hidden');
        };

        window.register = async () => {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const ref = document.getElementById('reg-ref').value.toUpperCase();
            if(!name || !email || !pass) return alert("Fill all fields");

            try {
                const cRef = doc(db, "settings", "counters");
                const resID = await runTransaction(db, async (t) => {
                    const s = await t.get(cRef);
                    const count = (s.exists() ? s.data().userCount : 0) + 1;
                    const id = `KP${String(count).padStart(5, '0')}`;
                    t.set(cRef, { userCount: count });
                    return id;
                });

                const uc = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", uc.user.uid), {
                    uid: uc.user.uid, name, email, userId: resID, referralId: ref,
                    topupBalance: 0, incomeBalance: 0, package: 0, role: 'user', bankLocked: false,
                    packageIncome: 0, level1Income: 0, level2Income: 0, level3Income: 0
                });
                await setDoc(doc(db, "idMapping", resID), { email });
                alert("Registered! ID: " + resID);
            } catch (e) { alert(e.message); }
        };

        window.login = async () => {
            const id = document.getElementById('login-uid').value.trim().toUpperCase();
            const pass = document.getElementById('login-pass').value;
            try {
                const m = await getDoc(doc(db, "idMapping", id));
                if(!m.exists()) throw new Error("Invalid User ID");
                await signInWithEmailAndPassword(auth, m.data().email, pass);
                window.location.href = 'dashboard.html';
            } catch (e) { alert(e.message); }
        };
    </script>
</body>
</html>